___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.

___INFO___

{
  "displayName": "SignalSight Conversion API",
  "description": "GTM server-side tag template for integrating with SignalSight\u0027s Conversion API Gateway, enabling smooth event forwarding to ad platforms like Facebook, TikTok, Google, and Snapchat.",
  "categories": [
    "ADVERTISING",
    "ANALYTICS",
    "ATTRIBUTION",
    "CONVERSIONS",
    "MARKETING",
    "REMARKETING",
    "LEAD_GENERATION"
  ],
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,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\u003d\u003d",
    "displayName": "signalsight.io",
    "id": "brand_dummy"
  },
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "apiToken",
    "displayName": "API Token",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Enter your API token for authentication."
  },
  {
    "type": "TEXT",
    "name": "test_event_code",
    "displayName": "Test Event Code (optional)",
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "platformSettings",
    "label": "Platform Settings",
    "description": "Configure platform-specific settings",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "fb",
        "checkboxText": "Facebook",
        "simpleValueType": true,
        "defaultValue": true
      },
      {
        "type": "CHECKBOX",
        "name": "tt",
        "checkboxText": "Tiktok",
        "simpleValueType": true
      },
      {
        "type": "CHECKBOX",
        "name": "ge",
        "checkboxText": "Google",
        "simpleValueType": true
      },
      {
        "type": "CHECKBOX",
        "name": "sn",
        "checkboxText": "Snapchat",
        "simpleValueType": true
      },
      {
        "type": "CHECKBOX",
        "name": "tw",
        "checkboxText": "Twitter",
        "simpleValueType": true
      },
      {
        "type": "CHECKBOX",
        "name": "pn",
        "checkboxText": "Pinterest",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "enableEnhancement",
    "checkboxText": "Enable Event Enhancement",
    "simpleValueType": true,
    "help": "Enable Use of HTTP Only Secure Cookie (gtmeec) to Enhance Event Data",
    "defaultValue": true
  },
  {
    "type": "SELECT",
    "name": "eventType",
    "displayName": "Event Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "Purchase",
        "displayValue": "Purchase"
      },
      {
        "value": "ViewContent",
        "displayValue": "View Content"
      },
      {
        "value": "AddToCart",
        "displayValue": "Add To Cart"
      },
      {
        "value": "Lead",
        "displayValue": "Lead"
      },
      {
        "value": "CompleteRegistration",
        "displayValue": "Complete Registration"
      },
      {
        "value": "Contact",
        "displayValue": "Contact"
      },
      {
        "value": "VisitToPhysicalStore",
        "displayValue": "Visit To Physical Store"
      },
      {
        "value": "VisitToWhatsApp",
        "displayValue": "Visit To WhatsApp"
      },
      {
        "value": "custom",
        "displayValue": "Custom Event"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "customEventName",
    "displayName": "Custom Event Name",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "custom",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "actionSource",
    "displayName": "Action Source",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "website",
        "displayValue": "Website"
      },
      {
        "value": "email",
        "displayValue": "Email"
      },
      {
        "value": "app",
        "displayValue": "App"
      },
      {
        "value": "phone_call",
        "displayValue": "Phone Call"
      },
      {
        "value": "chat",
        "displayValue": "Chat"
      },
      {
        "value": "physical_store",
        "displayValue": "Physical Store"
      },
      {
        "value": "system_generated",
        "displayValue": "System Generated"
      },
      {
        "value": "other",
        "displayValue": "Other"
      }
    ],
    "simpleValueType": true
  }
]


___SANDBOXED_JS_FOR_SERVER___

const getAllEventData = require('getAllEventData');
const sendHttpRequest = require('sendHttpRequest');
const JSON = require('JSON');
const getTimestampMillis = require('getTimestampMillis');
const generateRandom = require('generateRandom');
const sha256Sync = require('sha256Sync');
const logToConsole = require('logToConsole');
const Math = require('Math');
const Object = require('Object');
const getCookieValues = require('getCookieValues');
const setCookie = require('setCookie');
const makeString = require('makeString');
const getType = require('getType');
const toBase64 = require('toBase64');
const getRequestHeader = require('getRequestHeader');
const computeEffectiveTldPlusOne = require('computeEffectiveTldPlusOne');
const fromBase64 = require('fromBase64');
const createRegex = require('createRegex');
const testRegex = require('testRegex');
const decodeUriComponent = require('decodeUriComponent');
const parseUrl = require('parseUrl');

const eventData = getAllEventData();

const commonCookie = eventData.common_cookie || {};

const cookieOptions = {
    domain: 'auto',
    path: '/',
    samesite: 'Lax',
    secure: true,
    'max-age': 7776000, // 90 days
    HttpOnly: !!data.useHttpOnlyCookie
};

function isConsentGivenOrNotRequired() {
    if (data.adStorageConsent !== 'required') return true;
    if (eventData.consent_state) return !!eventData.consent_state.ad_storage;
    const xGaGcs = eventData['x-ga-gcs'] || ''; // x-ga-gcs is a string like "G110"
    return xGaGcs[2] === '1';
}


if (!isConsentGivenOrNotRequired()) {
    return eventData.gtmOnSuccess();
}

function isHashed(value) {
    if (!value) {
        return false;
    }
    return makeString(value).match('^[A-Fa-f0-9]{64}$') !== null;
}

// Helper function to hash user data
function hashData(key, value) {
    if (!value) {
        return value;
    }

    const type = getType(value);

    if (type === 'undefined' || value === 'undefined') {
        return undefined;
    }

    if (type === 'array') {
        return value.map((val) => {
            return hashData(key, val);
        });
    }

    if (isHashed(value)) {
        return value;
    }

    value = makeString(value).trim().toLowerCase();

    if (key === 'ph') {
        value = normalizePhoneNumber(value);
    } else if (key === 'ct') {
        value = value.split(' ').join('');
    }

    return sha256Sync(value, {outputEncoding: 'hex'});
}

function saveEecData(userData) {
    let gtmeecCookie = {};

    if (userData.em) gtmeecCookie.em = userData.em;
    if (userData.ph) gtmeecCookie.ph = userData.ph;
    if (userData.ln) gtmeecCookie.ln = userData.ln;
    if (userData.fn) gtmeecCookie.fn = userData.fn;
    if (userData.ct) gtmeecCookie.ct = userData.ct;
    if (userData.st) gtmeecCookie.st = userData.st;
    if (userData.cn) gtmeecCookie.cn = userData.cn;
    if (userData.zp) gtmeecCookie.zp = userData.zp;
    if (userData.ge) gtmeecCookie.ge = userData.ge;
    if (userData.db) gtmeecCookie.db = userData.db;
    if (userData.country) gtmeecCookie.country = userData.country;
    if (userData.external_id) gtmeecCookie.external_id = userData.external_id;
    if (userData.fb_login_id) gtmeecCookie.fb_login_id = userData.fb_login_id;

    setCookie('_gtmeec', toBase64(JSON.stringify(gtmeecCookie)), {
        domain: 'auto',
        path: '/',
        samesite: 'strict',
        secure: true,
        'max-age': 7776000, // 90 days
        HttpOnly: true
    });
}

function getEecData(userData) {
    const cookieValues = getCookieValues('_gtmeec');
    if ((!cookieValues || cookieValues.length === 0) && !commonCookie._gtmeec) {
        return userData;
    }

    const encodedValue = cookieValues[0] || commonCookie._gtmeec;
    if (!encodedValue) {
        return userData;
    }

    const jsonStr = fromBase64(encodedValue);
    if (!jsonStr) {
        return userData;
    }

    const gtmeecData = JSON.parse(jsonStr);

    if (gtmeecData) {
        if (!userData.em && gtmeecData.em) userData.em = gtmeecData.em;
        if (!userData.ph && gtmeecData.ph) userData.ph = gtmeecData.ph;
        if (!userData.ln && gtmeecData.ph) userData.ln = gtmeecData.ln;
        if (!userData.fn && gtmeecData.fn) userData.fn = gtmeecData.fn;
        if (!userData.ct && gtmeecData.ct) userData.ct = gtmeecData.ct;
        if (!userData.st && gtmeecData.st) userData.st = gtmeecData.st;
        if (!userData.cn && gtmeecData.cn) userData.cn = gtmeecData.cn;
        if (!userData.zp && gtmeecData.zp) userData.zp = gtmeecData.zp;
        if (!userData.ge && gtmeecData.ge) userData.ge = gtmeecData.ge;
        if (!userData.db && gtmeecData.db) userData.db = gtmeecData.db;
        if (!userData.country && gtmeecData.country)
            userData.country = gtmeecData.country;
        if (!userData.external_id && gtmeecData.external_id)
            userData.external_id = gtmeecData.external_id;
        if (!userData.fb_login_id && gtmeecData.fb_login_id)
            userData.fb_login_id = gtmeecData.fb_login_id;
    }

    return userData;
}

function normalizePhoneNumber(phoneNumber) {
    if (!phoneNumber) return phoneNumber;
    const itemRegex = createRegex('^[0-9]$');
    return phoneNumber.split('').filter((item) => testRegex(itemRegex, item)).join('');
}

if (data.enableEnhancement) {
//TODO: neden user_data override ediyor
//eventData.user_data = getEecData(eventData.user_data);
    saveEecData(getEecData(eventData));
}

function getAmpData(eventData) {
    const userData = eventData.user_data || {};

    const commonCookie = eventData.common_cookie || {};

    let obj = {
        ph: hashData(userData.ph),
        em: hashData(userData.em),
        ge: hashData(userData.ge),
        db: hashData(userData.db),
        ct: hashData(userData.ct),
        zp: hashData(userData.zp),
        cn: hashData(userData.cn),
        fn: hashData(userData.fn),
        ln: hashData(userData.ln),
        subscription_id: userData.subscription_id,
        lead_id: userData.lead_id,
        external_id: userData.external_id,
        fb_login_id: userData.fb_login_id
    };

    const handleCookie = (platform, objKey, cookieName) => {
        if (data[platform]) {
            obj[objKey] = getCookieValues(cookieName)[0] || commonCookie[cookieName];
        }
    };

    handleCookie('fb', '_fbc', '_fbc');
    handleCookie('fb', '_fbp', '_fbp');
    handleCookie('tt', '_ttp', '_ttp');
    handleCookie('tt', 'ttclid', 'ttclid');
    handleCookie('sn', '_scid', '_scid');
    handleCookie('pn', '_epik', '_epik');
    handleCookie('ge', 'gclid', 'gclid');

    const url = eventData.page_location;
    const subDomainIndex = url ? computeEffectiveTldPlusOne(url).split('.').length - 1 : 1;

    const handleDynamicCookie = (platform, objKey, param) => {
        if (data[platform] && typeof obj[objKey] === 'undefined' && url) {
            const urlParsed = parseUrl(url);

            if (urlParsed && urlParsed.searchParams[param]) {
                const clid = decodeUriComponent(urlParsed.searchParams[param]);

                if (!obj[objKey] || (obj[objKey].split('.').pop() !== clid)) {
                    obj[objKey] = platform + subDomainIndex + getTimestampMillis() + clid;
                }
            }

            if (obj[objKey]) {
                setCookie(objKey, obj[objKey], cookieOptions);
            }
        }
    };

    handleDynamicCookie('fb', '_fbc', 'fbclid');
    handleDynamicCookie('tt', 'ttclid', 'ttclid');

    return obj;
}

function getProductData(items) {
    return items.map(item => ({
        id: item.item_id,
        quantity: item.quantity
    }));
}

function padStartCustom(str, targetLength, padString) {
    str = (str === undefined || str === null) ? '' : '' + str;
    padString = (padString === undefined || padString === null) ? ' ' : '' + padString;

    if (str.length >= targetLength) {
        return str;
    }

    targetLength = targetLength - str.length;

    while (padString.length < targetLength) {
        padString += padString;
    }

    return padString.slice(0, targetLength) + str;
}

function generateEid() {
    const segments = [8, 4, 4, 4, 12];
    return segments.map(segment => {

        var tempEid = generateRandom(0, Math.pow(16, segment) - 1).toString(16);
        return padStartCustom(tempEid, segment, '0');  // Convert to hexadecimal
    }).join('-');
}

function sendEventToApi(eventData) {
    const event = {
        eid: generateEid(),
        et: eventData.eventType === 'custom' ? eventData.customEventName : eventData.eventType,
        ua: data.actionSource === 'website' ? eventData.user_agent : data.actionSource,
        p: {
            event_time: Math.floor(getTimestampMillis() / 1000),
            currency: eventData.currency,
            value: eventData.value,
            contents: getProductData(eventData.items || []),
            content_type: "product",
            content_category: eventData.content_category,
            content_name: eventData.content_name
        },
        amp: getAmpData(eventData)
    };

    event.p = Object.keys(event.p).reduce((obj, key) => {
        if (event.p[key] !== undefined) obj[key] = event.p[key];
        return obj;
    }, {});

    event.amp = Object.keys(event.amp).reduce((obj, key) => {
        if (event.amp[key] !== undefined) obj[key] = event.amp[key];
        return obj;
    }, {});

    const requestBody = JSON.stringify(event);
    const requestHeaders = {
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + data.apiToken
        },
        method: 'POST'
    };

    sendHttpRequest('https://cpi.ssevt.com/push/', (statusCode, headers, body) => {
        if (statusCode >= 200 && statusCode < 300) {
            data.gtmOnSuccess();
        } else {
            logToConsole('Error sending event to SignalSight API. Status code:', statusCode, 'Response:', body);
            data.gtmOnFailure();
        }
    }, requestHeaders, requestBody);
}

sendEventToApi(eventData);


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cpi.ssevt.com/push/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbc"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbp"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_gtmeec"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_fbc"
              },
              {
                "type": 1,
                "string": "_fbp"
              },
              {
                "type": 1,
                "string": "_gtmeec"
              },
              {
                "type": 1,
                "string": "_ttp"
              },
              {
                "type": 1,
                "string": "_scid"
              },
              {
                "type": 1,
                "string": "_epik"
              },
              {
                "type": 1,
                "string": "ttclid"
              },
              {
                "type": 1,
                "string": "gclid"
              },
              {
                "type": 1,
                "string": "_p2s_gcl"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Send purchase event
  code: |-
    const mockData = {
      apiToken: '123abc',
      eventType: 'Purchase',
      actionSource: 'signalsight',
      currency:'USD',
      value: '130',
      content_category: 'E-commerce',
      content_name: 'Product'
    };

    runCode(mockData);
setup: ''


___NOTES___

Created on 11/11/2024, 19:07:07